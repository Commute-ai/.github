name: Sync Week from Features to Children

on:
  # Manual trigger
  workflow_dispatch:
  
  # Run every 30 minutes
  schedule:
    - cron: '*/30 * * * *'

permissions:
  issues: write
  contents: read

jobs:
  sync-week-to-children:
    runs-on: ubuntu-latest
    
    steps:
      - name: Sync Week field from Features to their children
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ORG_PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const ORG = 'Commute-ai';
            const PROJECT_NUM = 1;
            
            console.log('üîÑ Starting Week sync from Features to children...');
            
            // Query to get all project items with Feature type and their sub-issues
            const query = `
              query($org: String!, $projNum: Int!) {
                organization(login: $org) {
                  projectV2(number: $projNum) {
                    id
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            id
                            number
                            title
                            repository {
                              name
                              owner {
                                login
                              }
                            }
                            labels(first: 10) {
                              nodes {
                                name
                              }
                            }
                            subIssues(first: 50) {
                              nodes {
                                id
                                number
                                title
                                repository {
                                  owner {
                                    login
                                  }
                                  name
                                }
                              }
                            }
                          }
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldIterationValue {
                              title
                              iterationId
                              field {
                                ... on ProjectV2IterationField {
                                  id
                                  name
                                }
                              }
                            }
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ... on ProjectV2SingleSelectField {
                                  id
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            try {
              const data = await github.graphql(query, {
                org: ORG,
                projNum: PROJECT_NUM,
                headers: {
                  'GraphQL-Features': 'sub_issues'
                }
              });
              
              const project = data.organization.projectV2;
              const allItems = project.items.nodes;
              
              // Filter for Feature type issues
              const featureIssues = allItems.filter(item => {
                if (!item.content?.labels) return false;
                
                // Check if it has Feature label
                const hasFeatureLabel = item.content.labels.nodes.some(
                  label => label.name === 'Feature'
                );
                
                // Alternative: check Type field if using project fields
                const typeField = item.fieldValues.nodes.find(
                  fv => fv.field?.name === 'Type' && fv.name
                );
                const isFeatureType = typeField?.name === 'Feature';
                
                return hasFeatureLabel || isFeatureType;
              });
              
              console.log(`üìã Found ${featureIssues.length} Feature issues`);
              
              let totalSynced = 0;
              
              // Process each Feature issue
              for (const feature of featureIssues) {
                if (!feature.content?.subIssues?.nodes || feature.content.subIssues.nodes.length === 0) {
                  continue;
                }
                
                const featureTitle = feature.content.title;
                const featureNumber = feature.content.number;
                const featureRepo = feature.content.repository.name;
                
                console.log(`\nüéØ Processing Feature: ${featureRepo}#${featureNumber} - ${featureTitle}`);
                console.log(`   Found ${feature.content.subIssues.nodes.length} sub-issues`);
                
                // Get Feature's Week iteration
                const featureWeek = feature.fieldValues.nodes.find(
                  fv => fv.field?.name === 'Week' && fv.iterationId
                );
                
                if (!featureWeek) {
                  console.log('   ‚ö†Ô∏è Feature has no Week set, skipping');
                  continue;
                }
                
                console.log(`   üìÖ Feature Week: ${featureWeek.title}`);
                
                // Update each sub-issue
                for (const subIssue of feature.content.subIssues.nodes) {
                  const subRepo = subIssue.repository.name;
                  const subNumber = subIssue.number;
                  
                  console.log(`   üìå Syncing sub-issue: ${subRepo}#${subNumber}`);
                  
                  // Find sub-issue in project items
                  const subItem = allItems.find(
                    item => item.content?.id === subIssue.id
                  );
                  
                  if (!subItem) {
                    console.log(`      ‚ö†Ô∏è Sub-issue not in project, skipping`);
                    continue;
                  }
                  
                  // Check if sub-issue already has the same Week
                  const currentWeek = subItem.fieldValues.nodes.find(
                    fv => fv.field?.name === 'Week' && fv.iterationId
                  );
                  
                  if (currentWeek?.iterationId === featureWeek.iterationId) {
                    console.log(`      ‚úÖ Already synced to ${featureWeek.title}`);
                    continue;
                  }
                  
                  // Update the Week field
                  try {
                    const updateMutation = `
                      mutation($projId: ID!, $itemId: ID!, $fieldId: ID!, $iterId: String!) {
                        updateProjectV2ItemFieldValue(input: {
                          projectId: $projId
                          itemId: $itemId
                          fieldId: $fieldId
                          value: { iterationId: $iterId }
                        }) {
                          projectV2Item {
                            id
                          }
                        }
                      }
                    `;
                    
                    await github.graphql(updateMutation, {
                      projId: project.id,
                      itemId: subItem.id,
                      fieldId: featureWeek.field.id,
                      iterId: featureWeek.iterationId
                    });
                    
                    console.log(`      ‚úÖ Updated to ${featureWeek.title}`);
                    totalSynced++;
                    
                  } catch (updateError) {
                    console.log(`      ‚ùå Failed to update: ${updateError.message}`);
                  }
                }
              }
              
              console.log(`\n‚úÖ Sync complete! Updated ${totalSynced} sub-issues.`);
              
            } catch (error) {
              console.error('‚ùå Error during sync:', error.message);
              throw error;
            }
